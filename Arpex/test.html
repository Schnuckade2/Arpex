<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Arpex PvP Ranking & Tiers</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;line-height:1.6}
    header{background:#111;color:#fff;padding:14px;text-align:center}
    .nav{display:flex;gap:12px;justify-content:center;padding:10px;background:#1f2937}
    .nav a{color:#fff;text-decoration:none;font-weight:600;cursor:pointer;padding: 5px 10px; border-radius: 4px; transition: background 0.2s;}
    .nav a:hover{background: #374151;}
    .container{max-width:1000px;margin:20px auto;padding:12px}
    
    .player-card{display:flex;align-items:center;background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;gap:12px;cursor:pointer;box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.1s;}
    .player-card:active{transform: scale(0.99);}
    
    .rank-number {font-size: 1.1em; font-weight: bold; min-width: 30px; text-align: center; color: #374151;}
    .rank-1 {color: #d97706;} 
    .rank-2 {color: #9ca3af;} 
    .rank-3 {color: #b45309;}

    img.skin{width:64px;height:64px;object-fit:contain;border-radius:6px;image-rendering:pixelated;image-rendering:crisp-edges;}
    img.pvp-icon{width:22px;height:22px;vertical-align: middle;object-fit:contain;image-rendering:pixelated;image-rendering:crisp-edges;}
    
    .profile, .tier-card{background:#fff;padding:16px;border-radius:8px;box-shadow: 0 1px 3px rgba(0,0,0,0.1)}
    .back-btn{color:#2563eb;cursor:pointer;display:inline-block;margin-bottom:8px; font-weight: bold;}
    h2,h3{margin:15px 0 8px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px;}
    .muted{color:#6b7280}

    /* Custom Dropdown */
    .custom-select-container { position: relative; width: 100%; margin-bottom: 20px; font-family: Arial, sans-serif; }
    .select-selected { background-color: #fff; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
    .select-selected:after { content: ""; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid #374151; }
    .select-selected.select-arrow-active:after { border-top: none; border-bottom: 5px solid #374151; }
    .select-items { position: absolute; background-color: #fff; top: 100%; left: 0; right: 0; z-index: 99; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; max-height: 300px; overflow-y: auto; }
    .select-show { display: block; }
    .select-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
    .select-item:hover { background-color: #f3f4f6; }
    .select-item:last-child { border-bottom: none; }
    
    /* Tables */
    table {width: 100%; border-collapse: collapse; margin: 15px 0; background: #fff;}
    th, td {padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;}
    th {background: #f9fafb; font-size: 0.9em; text-transform: uppercase;}
    .badge { padding: 3px 7px; border-radius: 4px; font-weight: bold; font-size: 0.85em; display: inline-block;}
    .lt { background: #dbeafe; color: #1e40af; }
    .ht { background: #fee2e2; color: #991b1b; }
    .pro { background: #fef3c7; color: #92400e; }
    .explanation { background: #f8fafc; padding: 12px; border-left: 4px solid #1f2937; margin-bottom: 15px; font-size: 0.95em;}

    /* Ladeanimation */
    #loading { text-align:center; padding: 20px; font-weight:bold; color:#6b7280; }

    @media (max-width:600px){img.skin{width:48px;height:48px} table{font-size: 0.85em;}}
  </style>
</head>
<body>
  <header><h1>Arpex PvP Ranking</h1></header>
  <nav class="nav">
    <a onclick="showRanking()">Ranking</a>
    <a onclick="showPvPTypes()">PvP Arten</a>
    <a onclick="showTierSystem()">Tier System</a>
  </nav>

  <main class="container" id="content">
      <div id="loading">Lade Daten...</div>
  </main>

  <script>
    /***** CONFIG *****/
    const DEFAULT_ICON = 'icons/default.png';
    const JSON_FILE = 'data.json';

    // Variablen sind jetzt leer und werden gefüllt
    let players = [];
    let pvpTypes = [];

    /***** DATEN LADEN *****/
    async function initApp() {
        try {
            const response = await fetch(JSON_FILE);
            if(!response.ok) throw new Error("Fehler beim Laden der JSON");
            
            const data = await response.json();
            
            // Daten zuweisen
            players = data.players || [];
            pvpTypes = data.pvpTypes || [];

            // Punkte berechnen
            calculatePoints();

            // App starten
            showRanking();

        } catch (err) {
            console.error(err);
            document.getElementById('content').innerHTML = `
                <div style="color:red; text-align:center; padding:20px;">
                    <h3>Fehler beim Laden!</h3>
                    <p>Stelle sicher, dass die Datei 'data.json' existiert und du einen Webserver nutzt (nicht file://).</p>
                    <p>Fehler: ${err.message}</p>
                </div>`;
        }
    }

    function calculatePoints() {
        players.forEach(player => {
            let totalPoints = 0;
            if(player.stats) {
                const statsArray = Object.values(player.stats);
                totalPoints = statsArray.reduce((summe, kategorie) => {
                    return summe + (kategorie.points || 0);
                }, 0);
            }
            player.points = totalPoints;
        });
    }

    /***** UI LOGIK *****/

    function makeImg(src, className, alt){
      const img = document.createElement('img');
      if(className) img.className = className;
      img.alt = alt || '';
      img.src = src;
      img.onerror = function(){
        if(this.src && !this._triedDefault){
          this._triedDefault = true;
          this.src = DEFAULT_ICON;
        }
      };
      return img;
    }

    function createPlayerCard(p, index, subtext) {
        const card = document.createElement('div'); 
        card.className = 'player-card';
        card.onclick = () => showProfile(p.id);
        
        const rankDiv = document.createElement('div');
        rankDiv.className = `rank-number rank-${index + 1}`;
        rankDiv.innerText = `${index + 1}.`;
        card.appendChild(rankDiv);

        card.appendChild(makeImg(p.skin, 'skin', p.name));
        
        const text = document.createElement('div');
        text.innerHTML = `<strong>${escapeHtml(p.name)}</strong> — <span class='muted'>${subtext}</span>`;
        card.appendChild(text);

        return card;
    }

    function showRanking(){
      const content = document.getElementById('content');
      content.innerHTML = '<h2>Globales Ranking</h2>';
      
      const sortedList = [...players].sort((a,b)=>b.points-a.points);

      sortedList.forEach((p, index) => {
        const formattedPoints = p.points.toLocaleString('de-DE');
        const card = createPlayerCard(p, index, `${formattedPoints} Punkte`);
        content.appendChild(card);
      });
    }

    function showPvPTypes(){
      const content = document.getElementById('content');
      content.innerHTML = '<h2>PvP Arten</h2>';
      
      const selectContainer = document.createElement('div');
      selectContainer.className = 'custom-select-container';

      const selectedDiv = document.createElement('div');
      selectedDiv.className = 'select-selected';
      selectedDiv.innerHTML = '<span>Choose Game Mode</span>';
      
      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'select-items';

      const listContainer = document.createElement('div');
      listContainer.id = 'type-list';
      listContainer.innerHTML = '<p class="muted">Bitte wähle oben eine PvP Art aus.</p>';

      pvpTypes.forEach(type => {
          const item = document.createElement('div');
          item.className = 'select-item';
          item.innerHTML = `<img src="${type.icon}" class="pvp-icon"> ${type.name}`;
          
          item.onclick = function() {
              selectedDiv.innerHTML = `<div style="display:flex;align-items:center;gap:10px;"><img src="${type.icon}" class="pvp-icon"> ${type.name}</div>`;
              itemsDiv.classList.remove('select-show');
              selectedDiv.classList.remove('select-arrow-active');
              renderSpecificType(type.id, listContainer);
          };
          itemsDiv.appendChild(item);
      });

      selectedDiv.onclick = function(e) {
          e.stopPropagation();
          itemsDiv.classList.toggle('select-show');
          selectedDiv.classList.toggle('select-arrow-active');
      };

      window.onclick = function(e) {
          if (!e.target.matches('.select-selected') && !e.target.closest('.select-selected')) {
              if (itemsDiv.classList.contains('select-show')) {
                  itemsDiv.classList.remove('select-show');
                  selectedDiv.classList.remove('select-arrow-active');
              }
          }
      }

      selectContainer.appendChild(selectedDiv);
      selectContainer.appendChild(itemsDiv);
      content.appendChild(selectContainer);
      content.appendChild(listContainer);
    }

    function renderSpecificType(typeId, container) {
        container.innerHTML = ''; 
        if(!typeId) return;

        const type = pvpTypes.find(t => t.id === typeId);
        
        const header = document.createElement('h3');
        header.innerHTML = `<img src="${type.icon}" class="pvp-icon"> ${type.name} Ranking`;
        container.appendChild(header);

        const list = players
            .filter(p => p.stats && p.stats[type.id])
            .sort((a,b) => (b.stats[type.id].points || 0) - (a.stats[type.id].points || 0));

        if(list.length === 0){
            container.innerHTML += '<p class="muted">Keine Spieler für diesen Modus eingetragen.</p>';
        } else {
            list.forEach((p, index) => {
                const points = p.stats[type.id].points || 0;
                const card = createPlayerCard(p, index, `${points} PT`);
                container.appendChild(card);
            });
        }
    }

    function showTierSystem(){
      const content = document.getElementById('content');
      content.innerHTML = `
        <div class="tier-card">
          <h2>Einstufung & Tiers</h2>
          <div class="explanation">Die Tiers basieren auf deinen <strong>Punkten (PT)</strong>.</div>
          <table>
            <thead><tr><th>Bereich</th><th>Tier-Typ</th></tr></thead>
            <tbody>
              <tr><td>0-80</td><td><span class="badge lt">LT 5</span></td></tr>
              <tr><td>80-120</td><td><span class="badge ht">HT 5</span></td></tr>
              <tr><td>120-240</td><td><span class="badge lt">LT 4</span></td></tr>
              <tr><td>240-260</td><td><span class="badge ht">HT 4</span></td></tr>
              <tr><td>260-400</td><td><span class="badge lt">LT 3</span></td></tr>
              <tr><td>400-460</td><td><span class="badge ht">HT 3</span></td></tr>
              <tr><td>460-600</td><td><span class="badge lt">LT 2</span></td></tr>
              <tr><td>600-700</td><td><span class="badge ht">HT 2</span></td></tr>
              <tr><td>700-900</td><td><span class="badge lt">LT 1</span></td></tr>
              <tr><td>900-1000</td><td><span class="badge ht">HT 1</span></td></tr>
            </tbody>
          </table>
          <h3>Pro Tiers</h3>
          <table>
            <tbody>
              <tr><td>1000-1200</td><td><span class="badge pro">Pro Tier 5</span></td></tr>
              <tr><td>1200-1500</td><td><span class="badge pro">Pro Tier 4</span></td></tr>
              <tr><td>1500-1800</td><td><span class="badge pro">Pro Tier 3</span></td></tr>
              <tr><td>1800-2200</td><td><span class="badge pro">Pro Tier 2</span></td></tr>
              <tr><td>2200+</td><td><span class="badge pro">Pro Tier 1</span></td></tr>
            </tbody>
          </table>
        </div>`;
    }

    function showProfile(id){
      const p = players.find(x=>x.id===id);
      if(!p) return;
      const content = document.getElementById('content');
      content.innerHTML = `<div class="back-btn" onclick="showRanking()">← Zurück</div>
        <div class="profile">
          <h2>${escapeHtml(p.name)}</h2>
          <img src="${p.skin}" class="skin">
          <p><strong>Bio:</strong> ${escapeHtml(p.bio)}</p>
          <p><strong>Gesamtpunkte:</strong> ${p.points.toLocaleString('de-DE')}</p>
          <h3>PvP Stats</h3>
          <div id="stats-list"></div>
        </div>`;
      
      const list = document.getElementById('stats-list');
      pvpTypes.forEach(type => {
        const s = p.stats && p.stats[type.id];
        if(s){
          const div = document.createElement('p');
          div.innerHTML = `<img src="${type.icon}" class="pvp-icon"> <strong>${type.name}:</strong> ${s.LT || s.HT || ''} (${s.points} Pts)`;
          list.appendChild(div);
        }
      });
    }

    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]);
    }

    // Startet den Ladevorgang
    initApp();
  </script>
</body>
</html>